---
layout: post
title: "Ansible"
description: "Ansible"
categories: [AWS]
tags: [Ansible, Linux]
redirect_from:
  - /2020/08/20/
---

* Kramdown table of contents
{:toc .toc}


# Ansible
> - 오픈소스 IP 자동화 도구   
> - 사용하기 위해서는 파이썬과 SSH과 설치가 되어있어야 한다.   
> - 다수의 인스턴스가 있는 엔터프라이즈 환경에서 사용하기 적합하다.

![w1](https://user-images.githubusercontent.com/69279022/90725238-d450fc00-e2fa-11ea-8d4d-c504b7ecce42.png)



## Ansible 용어

## Control Node(Ansible Host)
> 시스템 관라자는 Control Node에 Ansible을 설치하고 원격으로 관리 노드들을 제어한다.    

## Managed Node(관리 Host)
> 관리 노드는 Control Node에 접근하여 모듈을 설치하고 원격의 명령을 실행하는 작업을 수행하는 시스템이다.   

## Inventory
> Inventory는 Host가 속해 있는 그룹을 정의하는 파일이다. Inventory에서 Control Node가 Managed Node와 통신하는 방법도 정의할 수 있으며 Host 및 Group의 변수까지 지정할 수 있다.   

## Module
> Module은 Managed Node에서 실행되는 명령들과 같으며 Control Node에 존재하는 Module이 Managed Node에 복사되어 관리 노드에서 실행된다.   

## Task
> Task는 Module의 집합으로 PlayBook에서 Task에 Module을 지정하여 지정된 Managed Host에 다수의 Module을 실행하게 할 수 있다.   

## PlayBook
> PlayBook은 Managed Node에서 실행할 Module을 인자와 함께 정의한 파일이다. 이 파일은 YAML로 작성되며 Ansible의 핵심이다.


![qq2](https://user-images.githubusercontent.com/69279022/90844396-bf2da900-e39e-11ea-8e8d-357518c60172.png)

![qq1](https://user-images.githubusercontent.com/69279022/90844400-c05ed600-e39e-11ea-964b-340a92d8ecaa.png)



<br>
<br>
<br>

# 초기 설치

<br>

## 실습환경

![w2](https://user-images.githubusercontent.com/69279022/90725757-9ef8de00-e2fb-11ea-8632-0fb7fc44b9ff.png)

- **Control Node** : 192.168.100.4
- **Managed Nodes** : 192.168.100.5 ~ 7 
- **OS** : Centos7

<br>

## Ansible 설치


` EPEL-REPO 설치 `
~~~
[user@control ~]$ sudo yum install repo-release
~~~
▶ Ansible을 설치하기 위해선 EPEL-REPO가 필요하다

` Ansible Package Install `
~~~
[user@control ~]$ sudo yum install ansible
~~~

` Ansible  bash 파일 적용 `
~~~
[user@control ~]$ sudo wegt https://github.com/dysosmus/ansible-completion/archive/master.zip
[user@control ~]$ unzip ~/master.zip
[user@control ~]$ cp ~/ansible-completion-master/*bash /etc/bash_completion.d/
~~~
▶ Ansible 자동 완성 기능을 위하여 해준다..

` 기본 hosts 파일 등록 `
~~~
[user@control ~]$ vi /etc/hosts
192.168.100.4 control
192.168.100.5 node1
192.168.100 6 node2
192.168.100.7 node3
~~~

` SSH 접속 확인 `
~~~
[user@control ~]$ ssh user@node1
[user@control ~]$ ssh user@node2
[user@control ~]$ ssh user@node3
~~~ 

` SSH key 생성 `
~~~
[user@control ~]$ ssh-keygen
~~~

` 공개키 복사`
~~~
[user@control ~]$ ssh-copy-id user@node1
[user@control ~]$ ssh-copy-id user@node2
[user@control ~]$ ssh-copy-id user@node3
~~~
▶ Control Node에서 Public Key(~/.ssh/d_rsa.pub)를 Node에(~/.ssh/authorized_keys)에 복사한다

` Ansible Hosts 파일 설정`
~~~
[user@control ~]$ vi /etc/ansible/hosts
node1
node2
node3
~~~
▶ 위에서 /etc/hosts에 등록한 정보를 등록한다. (IP로 등록가능)

## Ansible 설치 확인

` Hosts List 확인 `
~~~
[user@control ~]$ ansible --list-hosts all
hosts (3):
  node1
  node2
  node3
~~~
▶  /etc/ansible/hosts에 정상적으로 등록되었는지 확인한다.

` 모든 Node에 Ping `
~~~
[user@control ~]$ ansible all -m ping
~~~

` Node1, node2에 ping `
~~~
[user@control ~]$ ansible node1,node2 -m ping
~~~

` 모든 Node에 install `
~~~
[user@control ~]$ ansible all -m yum -a "name=httpd state=latest" --become
~~~
▶ **정상적으로 Install이 되지 않는다 **!
▶ yum은 관리자 권한이 필요하기 때문에 정상적으로 설치되지 않는다.
▶ 최신버전의 httpd를 설치한다

` 방법 1 `
~~~
[user@control ~]$  $ ansible all -m yum -a "name=httpd state=latest" --become --ask-become-pass
~~~
▶ 비밀번호 질의를 통해서 설치하는 방법


` 방법 2`
~~~
[root@node1 ~]# vi /etc/sudoers
user      ALL=(ALL)         NOPASSWD:ALL
~~~
▶  Node들 Sudodes 파일에 등록하는 방법    

<br>



# Inventory 관리

> - Ansible은 동시에 존재하는 다수의 시스템을 관리한다. 이 때 Ansible의 Inventory 파일에 나열된 시스템을 기준으로 작업을 수행한다. 이파일은 기본적으로 **/etc/ansible/hosts** 이며 명령줄에서 "-i [파일경로] "를 사용하여 특정 인벤토리 파일을 지정할 수 있다.   
> - 인벤토리 파일은 구성할 수 있을 뿐만 


<br>

## Host 와 Group

###  사용자 지정 inventory  파일 생성 
~~~
[user@control /etc/ansible]$ sudo mkdir inventory
[user@control /etc/ansible]$ sudo vi inventory/inventory.ini
node1
node2
node3
control
node1.test.local
node2.test.local
node3.test.local
192.168.100.5
192.168.100.6
192.168.100.7
~~~

` 파일 생성 확인 `
~~~
[user@control /etc/ansible]$ tree
.
├── ansible.cfg
├── hosts
├── inventory
│   └── inventory.ini
└── roles
~~~
~~~
[user@control /etc/ansible]$ ansible --list-hosts all -i inventory/inventory.ini
  hosts (10):
    node1
    node2
    node3
    control
    node1.test.local
    node2.test.local
    node3.local
    192.168.100.5
    192.168.100.6
    192.168.100.7
~~~
▶ **-i** 옵션을 사용하여 사용하는 Inventory를 지정하여 수행한다.

` Hosts에 Group 지정 `
~~~
[host]
node1
node2
node3

[domain]
node1.test.local
node2.test.local
node3.test.local

[ip]
192.168.100.5
192.168.100.6
192.168.100.7
~~~
▶ **"[]"** 안에 사용자 임의의 그룹을 지정하여 사용할 수 있다.

### 특정 Group List만 조회 

~~~
[user@control /etc/ansible]$ ansible --list-hosts host -i inventory/inventory.ini
  hosts (3):
    node1
    node2
    node3
~~~

<br>

### Group이 지정되지 않은 Node List 확인 
~~~
[user@control /etc/ansible]$ ansible --list-hosts ungrouped -i inventory/inventory.ini
~~~

<br>

### Host Node의 ssh 접속 Port가 다른 경우
~~~
[user@control /etc/ansible]$ sudo vi inventory/inventory.ini
[host]
node1:2222
node2:2222
node3:2222

[domain]
node1.test.local
node2.test.local
node3.test.local

[ip]
192.168.100.5
192.168.100.6
192.168.100.7
~~~
▶ 기본적으로 Ansible은 SSH를 사용하기 떄문에 Port가 22이 아닌경우 위와 같이 설정 해줄수 있다   

<br>

### 비슷한 이름의 Host Node 등록 
~~~
[user@control /etc/ansible]$ sudo vi inventory/inventory.ini
node[1:3]

[domain]
node[1:3].test.local

[ip]
192.168.100.[5:7]
~~~
▶ **[1:3]** : 1 ~ 3(1,2,3) 까지를 뜻한다.   
▶  문자도 **[a:d]** 형식으로 사용할 수 있다. (a ~ d 까지)






## Inventory 매개변수

> - ansible_become : ansible_sudo 또는 ansible_su와 동일하게 권한 상승을 강제로 할 수 있다.   
> - ansible_become_method : 권한 상승을 위한 방법을 정의한다.   
> - ansible_become_user : 권한 상승으로 설정할 사용자
> -

# Pattern
