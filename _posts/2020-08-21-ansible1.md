---
layout: post
title: "Ansible"
description: "Ansible"
categories: [Linux]
tags: [Devops, Ansible]
redirect_from:
  - /2020/08/21/
---

* Kramdown table of contents
{:toc .toc}


# Ansible

![w1](https://user-images.githubusercontent.com/69279022/90725238-d450fc00-e2fa-11ea-8d4d-c504b7ecce42.png)

- Ansible Core 

> 동작에 필요한 최소한의 Package   

- Ansible Tower

> - 편의성 증가   
> - GUI 지원   
> - 스케줄링 및 가시성 증가   

<br>

# Ansible 관련 파일

- /etc/ansible/ansible.cfg

> Ansible 환경 설정 파일  

- /etc/ansible/hosts

> Ansible이 접속하는 호스트들에 대한 정보     

# Ansible 옵션


## -i(--inventory-file)
> Host 정보를 가지고 있는 파일을 사용자가 별도로 정의하여 사용하기 위한 옵션 

` [ example ] `
> 
~~~
[kbd031@server ~]$ vi test
192.168.100.5
192.168.100.6
~~~
~~~
[kbd031@server ~]$ ansible all -m ping -i test    
192.168.100.5 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
192.168.100.6 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
~~~
- 기본으로 /etc/ansible/hosts 파일에 등록된 정보를 사용한다.
- 별도로 Inventory 파일을 생성하여 기본파일이 아닌 내가 생성한 파일의 정보를 사용한다. 
- Inventory 파일의 PATH은 절대 경로 또는 상대 경로로 설정이 가능하다.

<br>

## -m(--module-name)
>  Ansible 에서 사용할 Module을 지정하는 옵션 

 ` [ example ] `
 >
~~~
[kbd031@server ~]$ ansible all -m ping 
~
192.168.100.5 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
192.168.100.6 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
~~~
- **" Ping "** Module을 사용한다.
- Linux의 Ping Command와는 다르다. / Pyhon에서 Ping을 효과적으로 작성한 Module을 사용하는 것이다.
-  Module에 대한 것은 외부에서 가져오는 것이 아닌 내장 Module에서 직접 호출하여 실행한다.

<br>

## -k(--ask-pass)
>  Ansible 명령어 사용시 Password를 질의하도록 하는 옵션 

` [ example ] `
>
~~~
[kbd031@server ~]$ ansible all -m ping 
192.168.100.5 | UNREACHABLE! => {
    "changed": false, 
    "msg": "Failed to connect to the host via ssh: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).", 
    "unreachable": true
}
192.168.100.6 | UNREACHABLE! => {
    "changed": false, 
    "msg": "Failed to connect to the host via ssh: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).", 
    "unreachable": true
}
192.168.100.7 | UNREACHABLE! => {
    "changed": false, 
    "msg": "Failed to connect to the host via ssh: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).", 
    "unreachable": true
}
~~~
~~~
[kbd031@server ~]$ ansible all -m ping -k
SSH password: 
192.168.100.5 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
192.168.100.6 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
192.168.100.7 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
~~~
- Key 교환을 하지 않은 상태에서 **" -k "** 옵션을 사용하지 않고 명령어를 입력하면  Permission denied가 출력되며 정상적으로 동작하지 않는다.

<br>

## -K(--ask-become-pass)
> 관리자로 권한 상승을 위한 옵션

` [ example ] `
> 
~~~
[kbd031@server ~]$ ansible web -m ping -k -K
SSH password: 
BECOME password[defaults to SSH password]: 
192.168.100.6 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
192.168.100.5 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
192.168.100.7 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
~~~
- **" -K "** 옵션을 사용하면 sudo의 권한을 얻을 수 있다.
- -k 와 -K를 입력하면 Password를 두번 질의 하는데 기본으로는 SSH와 동일하게 되어 있다.

<br>

## - --list-hosts
> **Host List를 출력하여 확인하는데 사용하는 옵션**

` [ example ]  `
>
~~~
[kbd031@server ~]$ ansible all --list-host
  hosts (3):
    192.168.100.5
    192.168.100.6
    192.168.100.7
~~~
~~~
[kbd031@server ~]$ ansible web --list-host
  hosts (3):
    192.168.100.5
    192.168.100.6
    192.168.100.7
~~~
- **" all "** 을 사용하여 모든 Host List를 출력
- **" web "** 을 사용하여 선택한 Group의 Host List만 출력

<br><br>

# Ansible Core 설치

![z1](https://user-images.githubusercontent.com/69279022/90864781-47767300-e3cc-11ea-98de-fdc071741e85.png)

<br>

` EPEL Repository Install `
>
~~~
[kbd031@server ~]$ sudo yum install epel-release
~~~
- Ansible Package를 설치하기 위해서는 사전에 EPEL-RPRO를 설치해야 한다.  

<br>


` Ansible Package Install `
>
~~~
[kbd031@server ~]$ sudo yum install ansible
~~~

<br>

` Ansible TEST `
>
~~~
[user@server ~]$ ansible all -m ping
[WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all'
~~~
- Hosts List가 비어있어 정상적으로 되지 않는다고 나온다.

<br>

` /etc/ansible/hosts `
>
~~~
[kbd031@server ~]$ sudo vi /etc/ansible/hosts
[web]
192.168.100.5
192.168.100.6
192.168.100.7
~~~
- 아무곳에 추가로 작성한다.
- **[web]** 은 입력한 IP 들의 Group Name을 뜻한다.

<br>

` Ansible TEST `
>
~~~
[kbd031@server ~]$ ansible --list-hosts all
  hosts (3):
    192.168.100.5
    192.168.100.6
    192.168.100.7
~~~

` 등록한 모든 Host 확인 `
~~~
[kbd031@server ~]$ ansible all -m ping
192.168.100.6 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    },
    "changed": false,
    "ping": "pong"
}
192.168.100.5 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    },
    "changed": false,
    "ping": "pong"
}
192.168.100.7 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    },
    "changed": false,
    "ping": "pong"
}
~~~
- 모든 Host에 Ping 명령어가 성공하였다
- 처음 ssh로 접속하는 경우 Public Key 교환으로 인한 질의를 할 수 도 있는데 yes를 입력 후 다시해보자.

<br>

## SSH Public Key 교환
> Server에서 Host로 SSH 접속하려고 하면 비밀번호를 질의하는데 SSH Key를 교환하게 되면 Password를 질의하지 않는다.

>
~~~
[kbd031@server ~]$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/home/kbd031/.ssh/id_rsa): 
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /home/kbd031/.ssh/id_rsa.
Your public key has been saved in /home/kbd031/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:00MWqXKOw2AKwHzfft92HWFuwHZhSu+Jyd+xunZGaqE kbd031@server
The key's randomart image is:
+---[RSA 2048]----+
|o         ..     |
|.o .      .. . o |
|. . . .  .o o + .|
|.   o...o+   = = |
| . o o.=S o o O o|
|  .   +..o . = O |
|       .. . o * *|
|           E * *o|
|            +o*  |
+----[SHA256]-----+
~~~
~~~
[kbd031@server ~]$ cat ~/.ssh/id_rsa.pub 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCoHyqolR9MXcVV9yNHNMowJn3PkwDQhCFwzyViAbHLAdXS+eWeFmziKx7FSog24IrT+oldjc1Qxpqg4tt7D4D7eioHSWYv2ZLN9zzz1fVfTAyegkcmw7MMfv+BCVuxWLv0JCCHN8QGfTbh9VrF2fgItH532YM0gpprN1107inioxgx9lXCe4z26BqYF4J0JMFLYn2IoI7Z+GE80K+VhoZcI1t5nxA/qpIrC58eiJx8Q8dh02WskucCQiQ7Sumys9oti0tShzg2MU1MFdn9ysF816OfgVRTxcE/LhBbyuWONIhgsRvXkEZHN66e6q9cqHWeXUaImoMqILpL9qvmr2oD kbd031@server
~~~
~~~
[kbd031@server ~]$ ssh-copy-id host1@192.168.100.5
[kbd031@server ~]$ ssh-copy-id host2@192.168.100.6
[kbd031@server ~]$ ssh-copy-id host3@192.168.100.7
~~~
- SSH Key를 생성 후 **" id_rsa.pub "**의 정보를 복사해서 Host의 ~/.ssh/authorized_keys 파일에 넣어주어도 정상적으로 동작한다.


<br>

## Ansible Bash-Completion 설치
> Ansible 명령어의 자동완성 기능을 설치하여 편의성을 증가시킨다.

>
~~~
[user@control ~]$ sudo wegt https://github.com/dysosmus/ansible-completion/archive/master.zip
[user@control ~]$ unzip ~/master.zip
[user@control ~]$ cp ~/ansible-completion-master/*bash /etc/bash_completion.d/
~~~
- 인터넷에 ansible bash completion 이라고 검색하면 나오는 곳에서 다운로드하였다.

<br>

